
--
-- Create model Book
--
CREATE TABLE "BOOK_BOOK" ("ID" NUMBER(11) NOT NULL PRIMARY KEY, "NAME" NVARCHAR2(20) NULL, "PUB_DATE" DATE NULL, "AUTHOR" NVARCHAR2(20) NULL);
--
-- Create model Group
--
CREATE TABLE "BOOK_GROUP" ("ID" NUMBER(11) NOT NULL PRIMARY KEY, "NAME" NVARCHAR2(20) NULL, "OWNER_ID" NUMBER(11) NOT NULL);
CREATE TABLE "BOOK_GROUP_BOOKS" ("ID" NUMBER(11) NOT NULL PRIMARY KEY, "GROUP_ID" NUMBER(11) NOT NULL, "BOOK_ID" NUMBER(11) NOT NULL);

DECLARE
    i INTEGER;
BEGIN
    SELECT COUNT(1) INTO i FROM USER_SEQUENCES
        WHERE SEQUENCE_NAME = 'BOOK_BOOK_SQ';
    IF i = 0 THEN
        EXECUTE IMMEDIATE 'CREATE SEQUENCE "BOOK_BOOK_SQ"';
    END IF;
END;
/;

CREATE OR REPLACE TRIGGER "BOOK_BOOK_TR"
BEFORE INSERT ON "BOOK_BOOK"
FOR EACH ROW
WHEN (new."ID" IS NULL)
    BEGIN
        SELECT "BOOK_BOOK_SQ".nextval
        INTO :new."ID" FROM dual;
    END;
/;

DECLARE
    i INTEGER;
BEGIN
    SELECT COUNT(1) INTO i FROM USER_SEQUENCES
        WHERE SEQUENCE_NAME = 'BOOK_GROUP_SQ';
    IF i = 0 THEN
        EXECUTE IMMEDIATE 'CREATE SEQUENCE "BOOK_GROUP_SQ"';
    END IF;
END;
/;

CREATE OR REPLACE TRIGGER "BOOK_GROUP_TR"
BEFORE INSERT ON "BOOK_GROUP"
FOR EACH ROW
WHEN (new."ID" IS NULL)
    BEGIN
        SELECT "BOOK_GROUP_SQ".nextval
        INTO :new."ID" FROM dual;
    END;
/;
ALTER TABLE "BOOK_GROUP" ADD CONSTRAINT "BOOK_GROU_OWNER_ID_4AA62E5E_F" FOREIGN KEY ("OWNER_ID") REFERENCES "AUTH_USER" ("ID") DEFERRABLE INITIALLY DEFERRED;
CREATE INDEX "BOOK_GROUP_OWNER_ID_4AA62E5E" ON "BOOK_GROUP" ("OWNER_ID");

DECLARE
    i INTEGER;
BEGIN
    SELECT COUNT(1) INTO i FROM USER_SEQUENCES
        WHERE SEQUENCE_NAME = 'BOOK_GROUP_BOOKS_SQ';
    IF i = 0 THEN
        EXECUTE IMMEDIATE 'CREATE SEQUENCE "BOOK_GROUP_BOOKS_SQ"';
    END IF;
END;
/;

CREATE OR REPLACE TRIGGER "BOOK_GROUP_BOOKS_TR"
BEFORE INSERT ON "BOOK_GROUP_BOOKS"
FOR EACH ROW
WHEN (new."ID" IS NULL)
    BEGIN
        SELECT "BOOK_GROUP_BOOKS_SQ".nextval
        INTO :new."ID" FROM dual;
    END;
/;
ALTER TABLE "BOOK_GROUP_BOOKS" ADD CONSTRAINT "BOOK_GROU_GROUP_ID_C4B4D39D_F" FOREIGN KEY ("GROUP_ID") REFERENCES "BOOK_GROUP" ("ID") DEFERRABLE INITIALLY DEFERRED;
ALTER TABLE "BOOK_GROUP_BOOKS" ADD CONSTRAINT "BOOK_GROU_BOOK_ID_B2209DC5_F" FOREIGN KEY ("BOOK_ID") REFERENCES "BOOK_BOOK" ("ID") DEFERRABLE INITIALLY DEFERRED;
ALTER TABLE "BOOK_GROUP_BOOKS" ADD CONSTRAINT "BOOK_GROU_GROUP_ID__1D83016D_U" UNIQUE ("GROUP_ID", "BOOK_ID");
CREATE INDEX "BOOK_GROUP_GROUP_ID_C4B4D39D" ON "BOOK_GROUP_BOOKS" ("GROUP_ID");
CREATE INDEX "BOOK_GROUP_BOOK_ID_B2209DC5" ON "BOOK_GROUP_BOOKS" ("BOOK_ID");
COMMIT;
